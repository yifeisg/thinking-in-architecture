# 微信朋友圈高性能复杂度分析



## 数据收集

https://www.sohu.com/a/445526442_115565 *2021-01-19*

> 1 月 19 日晚，在微信公开课 Pro 上，微信创始人张小龙披露微信最新数据：每天有 10.9 亿用户打开微信，3.3 亿用户进行了视频通话；**有 7.8 亿用户进入朋友圈，1.2 亿用户发表朋友圈**，其中照片 6.7 亿张，短视频 1 亿条；有 3.6 亿用户读公众号文章，4 亿用户使用小程序。

https://www.phdmedia.com/phd-insight-wechat-infographic/ *2019-03-26*

一天内微信使用量分布图：

![](https://github.com/yifeisg/thinking-in-architecture/blob/main/week02/wechat_usage_during_a_day.jpg)

为了便于计算，我们将上面的折线图粗略转化为以下直方图：

![](https://github.com/yifeisg/thinking-in-architecture/blob/main/week02/wechat_usage_histogram.jpg)

## 业务指标分析

### 看朋友圈

假设 7.8 亿用户平均每人每天进入 3 次朋友圈，则朋友圈平均每天一共有 23.4 亿次访问。

假设朋友圈使用量的趋势与图中 APP 使用量的趋势一致，则其峰值出现于 8pm - 9pm，在这 1 小时里一共发生了总访问量的大约 8.5%，也就是约 2 亿次访问。

假设特殊时段（如除夕、跨年）朋友圈的访问量峰值是平时均值的 5 倍，则此时每小时约有 10 亿次访问。

假设这些访问量平均分布于这一小时中的每一秒，则折合到每一秒，有约 **28 万次看朋友圈 QPS**。

> 这 28 万 QPS 还不包括照片大图和短视频的加载，仅仅只是计算了进入朋友圈后下滑浏览的次数。并且根据下滑距离的不同，每个人浏览的朋友圈条数也不同，当浏览条数足够多时，一次进入朋友圈可能会触发多次 query。为了简化计算，这些复杂情况我们都不予考虑。

### 发朋友圈

发朋友圈的情况略有不同：

假设 1.2 亿用户每人每天发 1 条朋友圈，则约有 1.2 亿条，但这个数字明显不准确。

因为光是每天的新增短视频就有 1 亿条，一条朋友圈只能发一个短视频，因此这里就有了 1 亿条朋友圈。

一条朋友圈可以配 1 - 9 张照片，取中间值 5 张 / 条计算，则 6.7 亿张照片可以转化为约 1.3 亿条朋友圈。

我们无法知道有多少条只有文字的朋友圈，为了便于计算，我们假设纯文字朋友圈每天一共 0.7 亿条。则合计每天一共有 3 亿条朋友圈。

由于发朋友圈有很大一部分是业务相关，这部分体量在特殊时段（如除夕、跨年）会大幅减少，但同时段其他社交内容的体量又会增加，因此这里不做特殊时期峰值 x 5 的处理。但出于资源冗余的安全考虑，我们 x 2 作为余量，即假设发朋友圈的日峰值为 6 亿条。

那么按照之前的直方图分析，假设这 6 亿条朋友圈有 8.5% 是在 8pm - 9pm 这一个小时内发出，则一共有 5100 万次发布，约合每秒 **1.4 万条发朋友圈 TPS** 。

> 我们不用 “假设每条朋友圈有多少人浏览” 来计算看朋友圈的 QPS，一是因为每次 query 肯定不止拉取一条朋友圈，二是这些浏览也不一定都发生在一秒内，因此这样的估算有些不准确。

### 点赞评论

假设平均到每条朋友圈下有 5 个点赞和 5 条评论，且假设每秒新增朋友圈数与每秒新增点赞 / 评论数成正相关，则一共是 **7 万个点赞 TPS** 和 **7 万条评论 TPS**。

> 好吧我偷懒了，因为数据不足，只能这么估算，实际点赞数肯定是超过评论数的

![](https://github.com/yifeisg/thinking-in-architecture/blob/main/week02/by_case_analysis.jpg)